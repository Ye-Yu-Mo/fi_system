# 财务投资系统需求文档（Finance & Investment System）

**版本**：v1.0
**优先级**：P0（现在做）
**状态**：待实施

---

## 0. 系统定位

### 0.1 这是什么

**一句话定义：**
> 支持 AI 自动记账的个人财务管理系统 + 投资纪律工具。

**核心价值：**
1. **不想手动记账** → MCP Server + Claude 自动记录
2. **财务数据难管理** → 统一存储（账户、交易、持仓）
3. **投资缺乏纪律** → 定投系统强制执行规则

**不是什么：**
- ❌ 不是理财顾问
- ❌ 不是量化交易平台
- ❌ 不是预测工具

---

### 0.2 目标用户

你自己。

- 有多个账户（银行卡、支付宝、微信、股票、基金、加密货币）
- 想自动记录消费（用 Claude 说话就能记账）
- 想导入账单（支付宝/微信 CSV）
- 想有投资纪律（定投系统）
- 不想被飞书/Notion 绑定

---

## 1. MVP 功能范围（必须做）

### 1.1 财务管理（Finance Domain）

#### 1.1.1 账户（Account）
- 创建/编辑/删除账户
- 账户类型：银行卡、支付宝、微信、现金、股票、基金、加密货币
- 支持多币种（账户关联币种代码）
- 显示账户余额（基于交易计算，不手动输入）

#### 1.1.2 交易（Transaction）
- 手动添加交易
- 导入交易（支付宝/微信 CSV/XLSX）
- 交易类型：收入、支出、转账、投资
- 交易分类（餐饮、购物、交通、投资等）
- 交易查询：
  - 按时间区间
  - 按分类
  - 按账户
  - 按金额区间

#### 1.1.3 持仓（Holdings）
- 记录金融资产（股票、基金、加密货币）
- 手动添加持仓
- 记录成本、数量、当前市值
- 持仓列表（按账户/资产类型筛选）

#### 1.1.4 财务报表
- 每日消费统计
- 分类统计（饼图/柱状图）
- 月度支出趋势
- 账户余额变化

---

### 1.2 MCP Server（AI 集成）

**核心能力：**
- Claude 可以通过 MCP 协议调用工具：
  - `create_transaction` - 创建交易
  - `create_holding` - 创建持仓
  - `get_account_balance` - 查询账户余额
  - `get_spending_summary` - 查询消费统计

**使用场景：**
```
用户：我刚买了咖啡 30 块
Claude：好的，已记录到支付宝账户，分类：餐饮

用户：这个月花了多少钱？
Claude：本月支出 ¥4,320，分类：餐饮 ¥1,200，购物 ¥800...
```

**技术要求：**
- MCP Server 集成在后端
- Claude Desktop 通过 MCP 协议连接
- 配置文件：`~/.config/claude/mcp_servers.json`

---

### 1.3 定投纪律系统（Investment Discipline）

**核心模块：**

#### 1.3.1 现金流管理
- 输入：月收入、月固定支出
- 计算：月自由现金流
- 现金桶划分：
  - **活钱桶**：≥ 1.5 × 月支出（随时可用）
  - **缓冲桶**：≥ 3 × 月支出（低风险、数日内可变现）

#### 1.3.2 阶段判定
- **阶段 1**：活钱桶未达标（禁止定投）
- **阶段 2**：活钱桶达标，缓冲桶未达标（仅基础定投）
- **阶段 3**：两个现金桶均达标（可启用加速包）

#### 1.3.3 定投执行
- **基础定投**：
  - 周期固定（如每周/每月）
  - 金额固定
  - 不因阶段变化而取消

- **加速包**（可选）：
  - 仅在阶段 3 启用
  - 一旦启用，视为长期承诺

#### 1.3.4 资产配置
- 设置资产比例（如：权益 70%、债基 20%、黄金 10%）
- 系统根据比例计算每次定投金额

#### 1.3.5 行动指令
- 输出明确、可执行的指令：
  - "本周买入 ¥500（权益 ¥350、债基 ¥100、黄金 ¥50）"
  - "本月不允许启用加速包"
  - "优先补充活钱桶缺口 ¥800"

#### 1.3.6 卖出规则
**唯一合法卖出理由：**
1. 年度再平衡（资产比例偏离 >10%）
2. 真实生活用钱（且现金桶已耗尽）
3. 资产逻辑永久性失效（非价格波动）

**明确禁止的卖出理由：**
- 市场涨跌
- 新闻、恐慌
- "我觉得现在不对"

---

### 1.4 数据导入（CSV/XLSX）

**支持格式：**
- 支付宝账单（CSV/XLSX）
- 微信账单（CSV/XLSX）

**功能要求：**
- 自动识别交易类型（收入/支出/转账）
- 自动映射分类（基于关键词）
- 去重（检测已存在的交易）
- 批量导入
- 导入日志（成功/失败记录）

---

## 2. 数据模型

### 2.1 核心表

**users**（用户表）
```sql
id: UUID (主键)
username: String (唯一)
password_hash: String
created_at: Timestamp
updated_at: Timestamp
```

**accounts**（账户表）
```sql
id: UUID (主键)
user_id: UUID (外键 → users)
name: String (账户名称)
type: Enum (bank/alipay/wechat/cash/stock/fund/crypto)
currency_code: String (币种，如 CNY/USD)
initial_balance: Decimal (初始余额，可选)
created_at: Timestamp
updated_at: Timestamp
```

**transactions**（交易表）
```sql
id: UUID (主键)
user_id: UUID (外键 → users)
account_id: UUID (外键 → accounts)
type: Enum (income/expense/transfer/investment)
amount: Decimal (金额)
category: String (分类，可选)
merchant: String (商户，可选)
description: String (备注，可选)
transaction_date: Date
created_at: Timestamp
updated_at: Timestamp
```

**holdings**（持仓表）
```sql
id: UUID (主键)
user_id: UUID (外键 → users)
account_id: UUID (外键 → accounts)
asset_type: Enum (stock/fund/crypto/bond/cash/other)
symbol: String (代码，如 AAPL)
name: String (名称，可选)
quantity: Decimal (数量)
cost_basis_total: Decimal (成本总额)
currency_code: String (币种)
last_price: Decimal (最新价格，可选)
last_price_at: Timestamp (价格更新时间，可选)
market_value: Decimal (市值，可选)
created_at: Timestamp
updated_at: Timestamp

UNIQUE (account_id, asset_type, symbol)
```

**investment_settings**（定投配置表）
```sql
id: UUID (主键)
user_id: UUID (外键 → users)
monthly_income: Decimal (月收入)
monthly_expense: Decimal (月支出)
cash_reserve_target: Decimal (活钱桶目标)
buffer_reserve_target: Decimal (缓冲桶目标)
base_investment_amount: Decimal (基础定投金额)
base_investment_frequency: Enum (weekly/monthly)
boost_investment_amount: Decimal (加速包金额，可选)
asset_allocation: JSON (资产配置比例，如 {"equity": 0.7, "bond": 0.2, "gold": 0.1})
created_at: Timestamp
updated_at: Timestamp
```

**investment_actions**（定投执行记录）
```sql
id: UUID (主键)
user_id: UUID (外键 → users)
action_date: Date (执行日期)
stage: Int (阶段 1/2/3)
instruction: Text (行动指令)
executed: Boolean (是否执行)
created_at: Timestamp
```

---

## 3. API 设计（RESTful）

### 3.1 认证
```
POST /register
POST /login
```

### 3.2 账户
```
GET    /accounts          (列表)
POST   /accounts          (创建)
GET    /accounts/:id      (详情)
PUT    /accounts/:id      (更新)
DELETE /accounts/:id      (删除)
```

### 3.3 交易
```
GET    /transactions      (列表，支持筛选：account_id, type, start_date, end_date)
POST   /transactions      (创建)
GET    /transactions/:id  (详情)
PUT    /transactions/:id  (更新)
DELETE /transactions/:id  (删除)
POST   /transactions/import  (导入 CSV/XLSX)
```

### 3.4 持仓
```
GET    /holdings          (列表，支持筛选：account_id, asset_type)
POST   /holdings          (创建)
GET    /holdings/:id      (详情)
PUT    /holdings/:id      (更新)
DELETE /holdings/:id      (删除)
```

### 3.5 报表
```
GET /reports/daily?date=2025-01-01
GET /reports/monthly?year=2025&month=1
GET /reports/category-summary?start_date=2025-01-01&end_date=2025-01-31
```

### 3.6 定投系统
```
GET    /investment/settings        (获取配置)
PUT    /investment/settings        (更新配置)
GET    /investment/stage           (当前阶段)
GET    /investment/actions         (行动指令列表)
POST   /investment/actions/:id/execute  (标记为已执行)
```

### 3.7 MCP 工具（通过 MCP 协议调用，非 HTTP）
```
create_transaction(account_id, type, amount, category, description, date)
create_holding(account_id, asset_type, symbol, name, quantity, cost_basis_total, currency_code)
get_account_balance(account_id)
get_spending_summary(start_date, end_date)
get_investment_instruction()
```

---

## 4. 前端功能

### 4.1 Dashboard（首页）
- 今日消费
- 本月消费
- 账户余额卡片
- 定投阶段指示器
- 本周/本月定投指令

### 4.2 账户页面
- 账户列表（显示余额）
- 创建/编辑/删除账户

### 4.3 交易页面
- 交易列表（支持筛选）
- 创建/编辑/删除交易
- 导入账单按钮（上传 CSV/XLSX）
- 分类图表（饼图）

### 4.4 持仓页面
- 持仓列表（显示成本、市值、收益率）
- 创建/编辑/删除持仓
- 按账户/资产类型筛选

### 4.5 定投系统页面
- 配置管理（月收入、月支出、现金桶目标、定投金额、资产配置）
- 当前阶段显示
- 行动指令列表（待执行/已执行）
- 现金桶达标进度条

### 4.6 报表页面
- 消费趋势图（按月）
- 分类统计图（饼图/柱状图）
- 账户余额变化图

---

## 5. 技术栈

### 5.1 后端
- **语言**：Go 或 Rust
  - 推荐 Go（MCP Server 库更成熟）
- **Web 框架**：Axum (Rust) / Gin (Go)
- **数据库**：PostgreSQL
- **ORM**：SeaORM (Rust) / GORM (Go)
- **MCP Server**：集成在后端进程

### 5.2 前端
- **框架**：React + TypeScript
- **构建工具**：Vite
- **状态管理**：TanStack Query（数据层）
- **表单**：React Hook Form
- **样式**：Tailwind CSS
- **图表**：Recharts
- **表格**：TanStack Table
- **CSV 解析**：PapaParse
- **XLSX 解析**：SheetJS (xlsx)

### 5.3 部署
- **后端**：单个二进制文件，部署在本地或 VPS
- **前端**：静态文件，nginx 或 Caddy 托管
- **数据库**：PostgreSQL（本地或托管）
- **MCP Server**：后端启动时自动启动，监听端口

---

## 6. 部署架构

```
┌─────────────────┐
│ Claude Desktop  │
└────────┬────────┘
         │ MCP 协议
         ↓
┌─────────────────┐
│  后端服务       │  (Go/Rust)
│  - HTTP API     │
│  - MCP Server   │
└────────┬────────┘
         ↓
┌─────────────────┐
│  PostgreSQL     │
└─────────────────┘

         ↑
         │ HTTP
┌─────────────────┐
│  Web 前端       │  (React)
│  - 查看数据     │
│  - 编辑数据     │
│  - 导入 CSV     │
└─────────────────┘
```

**部署方式：**
1. 本地部署（推荐，初期）
   - 后端：`http://localhost:3000`
   - 前端：`http://localhost:5173`
   - MCP Server：`http://localhost:3001`（或集成在 3000）

2. VPS 部署（可选，远程访问）
   - 后端：`https://api.yourdomain.com`
   - 前端：`https://app.yourdomain.com`
   - MCP Server：通过 VPN/SSH 隧道访问

---

## 7. MVP 实施优先级

### 第一阶段（2 周）：基础财务管理
- [ ] 后端框架搭建 + 数据库设计
- [ ] 账户 CRUD API
- [ ] 交易 CRUD API
- [ ] 前端脚手架 + 账户页面
- [ ] 前端交易页面
- [ ] 认证系统（简单 Token）

### 第二阶段（1 周）：MCP 集成
- [ ] MCP Server 实现
- [ ] 实现 MCP 工具：create_transaction, create_holding
- [ ] 配置 Claude Desktop 连接
- [ ] 测试 AI 自动记账

### 第三阶段（1 周）：CSV 导入
- [ ] 支付宝 CSV 解析
- [ ] 微信 CSV 解析
- [ ] 前端上传组件
- [ ] 导入日志展示

### 第四阶段（2 周）：持仓管理
- [ ] 持仓 CRUD API
- [ ] 前端持仓页面
- [ ] 持仓列表展示

### 第五阶段（2 周）：定投系统
- [ ] 定投配置 API
- [ ] 阶段判定逻辑
- [ ] 行动指令生成
- [ ] 前端定投配置页面
- [ ] 前端行动指令展示

### 第六阶段（1 周）：报表
- [ ] 报表 API
- [ ] 前端 Dashboard
- [ ] 前端报表页面（图表）

**总计：9 周（约 2 个月）**

---

## 8. 明确不做的内容（MVP）

**财务管理：**
- ❌ 外部数据源同步（币安、雪球）→ 手动添加即可
- ❌ 自动分类（关键词映射）→ 手动选择分类
- ❌ 预算提醒

**定投系统：**
- ❌ 自动下单（自动买入资产）
- ❌ 市场行情同步
- ❌ 收益回测

**AI 集成：**
- ❌ 自动分析消费与体重关联（没有体重数据）
- ❌ 投资建议生成

**其他：**
- ❌ 移动 App
- ❌ 多用户/团队协作
- ❌ 数据导出（除了 CSV 导入）

---

## 9. 未来扩展（MVP 后考虑）

**优先级 P1**（MVP 稳定后 3 个月内）：
- 外部数据源同步（币安、雪球 API）
- 自动分类（关键词映射）
- 预算提醒
- 数据导出（导出 CSV/XLSX）

**优先级 P2**（6 个月后）：
- 量化交易模块（回测、策略执行）
- 自动下单（币安/雪球）
- 移动端（React Native 或 PWA）

**优先级 P3**（1 年后，视需求）：
- 多用户支持
- 权限管理
- 数据备份/恢复

---

## 10. 成功标准

**MVP 成功的标志：**
1. ✅ 你每天用 Claude 记录消费（而不是手动打开 App）
2. ✅ 你每周导入一次支付宝/微信账单
3. ✅ 你每月看一次财务报表
4. ✅ 你每周/月按定投系统指令执行定投
5. ✅ 持续使用 3 个月没放弃

**不是成功标准：**
- ❌ 功能有多少
- ❌ 代码有多优雅
- ❌ 投资收益率

---

## 11. 风险与假设

**风险：**
1. MCP Server 集成可能比预期复杂
2. CSV 解析可能遇到格式不一致
3. 定投系统的规则可能不适合你的实际情况

**假设：**
1. 你会真的用 Claude 记账（而不是觉得麻烦又回去手动记）
2. 你会坚持定投纪律（而不是情绪化操作）
3. 你会持续导入账单（而不是偷懒）

**缓解措施：**
- 第一阶段先做基础财务管理，验证你会用
- 第二阶段再做 MCP，验证 AI 记账好用
- 第五阶段才做定投系统，验证财务数据足够

---

## 12. 附录：Linus 式警告

**这个系统不保证：**
- 你会变得更有钱
- 你会做出更聪明的投资决策
- 你会持续使用

**这个系统只保证：**
- 数据不丢失
- 逻辑干净
- 设计简单

**如果你：**
- 不想每天跟 Claude 说话记账 → 别做 MCP
- 不想导入账单 → 别做 CSV 导入
- 不想遵守定投纪律 → 别做定投系统

**做之前，先问自己：**
> 我是真的会用，还是觉得应该有？

**如果答案是后者，别浪费时间。**

---

**文档结束。开始写代码之前，再读一遍这个文档。**
